
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="https://www.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#4285F4">
    <meta name="description" content="Aplikasi PWA untuk mencatat absensi siswa secara online, terintegrasi dengan Google Sheets." />
    <title>Absensi Online Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Scripts will be loaded dynamically by the module -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://rsms.me/inter/inter.css');
        .screen { display: none; }
        .screen.active { display: block; }
        #loader-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: rgba(241, 245, 249, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .loader {
            border: 4px solid #e2e8f0; border-top: 4px solid #3b82f6;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        .loader-text { margin-top: 16px; color: #475569; font-weight: 500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- Animations for Success Screen --- */
        .checkmark-wrapper { width: 100px; height: 100px; }
        .checkmark { width: 100px; height: 100px; border-radius: 50%; display: block; stroke-width: 4; stroke: #4CAF50; stroke-miterlimit: 10; margin: 0 auto; box-shadow: inset 0px 0px 0px #4CAF50; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke-miterlimit: 10; stroke: #4CAF50; fill: none; animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; stroke-width: 4; animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 50px #4CAF50; } }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root">
        <!-- Initial Loader / Saving Loader -->
        <div id="loader-wrapper">
            <div class="loader"></div>
            <p class="loader-text">Memuat Aplikasi Absensi...</p>
        </div>

        <!-- App Screens -->
        <div id="app-container" class="hidden">
            <!-- All screen templates will be injected here by JavaScript -->
        </div>
    </div>

<script type="module">
    // --- CONFIGURATION ---
    const API_KEY = 'AIzaSyAoriBT31QhnPKAVH-t2-ANV7AiYdKjfsE';
    const CLIENT_ID = '584511730006-avkntpukucstgnf7c0otn3dt0lajtu43.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
    const SPREADSHEET_TITLE = 'Data Absensi Siswa';
    const CLASSES = ["1A", "1B", "2A", "2B", "3A", "3B", "4A", "4B", "5A", "5B", "6A", "6B"];
    
    // --- APPLICATION STATE ---
    let state = {
        tokenClient: null,
        userProfile: null,
        spreadsheetId: null,
        currentScreen: 'login', // login, setup, add-students, attendance, success, data, confirmation, privacy, terms
        selectedClass: '',
        selectedDate: new Date().toISOString().split('T')[0],
        students: [], // students for the current class
        attendance: {}, // { studentName: status }
        savedLogs: [], // historical attendance logs
        historyClassFilter: null, // to filter history view by class
        newStudents: [''], // for add-students screen
    };

    // --- DOM ELEMENTS ---
    const root = document.getElementById('root');
    const appContainer = document.getElementById('app-container');
    const loaderWrapper = document.getElementById('loader-wrapper');

    // --- TEMPLATES ---
    const templates = {
        login: () => `
            <div class="screen active min-h-screen flex flex-col items-center justify-center p-4 text-center">
                <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full">
                    <img src="https://www.gstatic.com/images/branding/product/1x/sheets_2020q4_48dp.png" alt="Google Sheets Logo" class="mx-auto mb-4"/>
                    <h1 class="text-2xl font-bold text-slate-800">Absensi Online SDN 2 Padangsambian</h1>
                    <p class="text-slate-500 mt-2 mb-6">Aplikasi pencatatan absensi siswa terintegrasi dengan Google Sheets.</p>
                    <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-full transition duration-300 flex items-center justify-center gap-2" disabled>
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.519-3.108-11.127-7.481l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,35.17,44,30.023,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                        <span id="loginBtnText">Memuat...</span>
                    </button>
                    <div id="auth-error-container" class="text-left text-sm mt-4 hidden">
                        <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                            <p id="auth-error-message" class="text-red-700 font-semibold mb-2"></p>
                            <div id="origin-helper" class="hidden">
                                <p class="text-slate-600 mb-2">Pastikan URL di bawah ini telah ditambahkan ke **Authorized JavaScript origins** di Google Cloud:</p>
                                <div class="flex items-center gap-2 bg-slate-100 p-2 rounded">
                                    <code id="auth-error-origin" class="text-blue-700 text-xs break-all"></code>
                                    <button id="copy-origin-btn" title="Salin URL" class="text-slate-500 hover:text-slate-800 flex-shrink-0">
                                        <svg id="copy-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                        <svg id="check-icon" class="w-4 h-4 text-green-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <p id="auth-error-tech-details" class="text-slate-500 text-xs mt-2"></p>
                        </div>
                    </div>
                     <div class="mt-6 text-xs text-slate-500">
                        <p>Dengan melanjutkan, Anda menyetujui</p>
                        <a href="#terms" class="font-semibold text-blue-600 hover:underline">Ketentuan Layanan</a> &
                        <a href="#privacy" class="font-semibold text-blue-600 hover:underline">Kebijakan Privasi</a>
                    </div>
                </div>
            </div>`,
        setup: (user) => `
            <div class="screen active min-h-screen flex flex-col items-center justify-center p-4">
                <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-xl font-bold text-slate-800">Absensi Online Siswa</h1>
                        <button id="logoutBtn" class="text-slate-500 hover:text-red-500 transition duration-300 p-2 rounded-full -mr-2" title="Logout">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>

                    <div class="flex items-center gap-4 mb-8 p-4 bg-slate-50 rounded-lg">
                        <img src="${user.picture}" alt="User" class="w-12 h-12 rounded-full"/>
                        <div>
                            <p class="font-semibold text-slate-800">${user.name}</p>
                            <p class="text-sm text-slate-500">${user.email}</p>
                        </div>
                    </div>
                    
                    <h2 class="text-lg font-semibold text-slate-700 mb-4">Pilih Kelas & Tanggal</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="class-select" class="block text-sm font-medium text-slate-700 mb-1">Pilih Kelas</label>
                            <select id="class-select" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">${CLASSES.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                        </div>
                        <div>
                            <label for="date-input" class="block text-sm font-medium text-slate-700 mb-1">Tanggal</label>
                            <input type="date" id="date-input" value="${state.selectedDate}" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"/>
                        </div>
                    </div>
                    <div class="mt-6 space-y-3">
                         <button id="startBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-full transition duration-300" disabled>Mulai Absensi</button>
                         <button id="historyBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-lg w-full transition duration-300">Lihat Riwayat Kelas Terpilih</button>
                    </div>
                    <p id="setup-status" class="text-center text-sm text-slate-500 mt-4 h-5"></p>
                </div>
            </div>`,
        addStudents: (className) => `
            <div class="screen active p-4 md:p-8 max-w-4xl mx-auto">
                 <div class="bg-white p-8 rounded-2xl shadow-lg">
                    <h1 class="text-2xl font-bold text-slate-800 mb-2">Tambah Data Siswa</h1>
                    <p class="text-slate-500 mb-6">Data siswa untuk <span class="font-semibold text-blue-600">${className}</span> belum ada. Silakan tambahkan di bawah ini.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Manual Input -->
                        <div class="border-r-0 md:border-r md:pr-8 border-slate-200">
                             <h2 class="text-lg font-semibold text-slate-700 mb-4">Tambah Manual</h2>
                             <div id="manual-input-container" class="space-y-3 mb-4 max-h-60 overflow-y-auto pr-2"></div>
                             <button id="add-student-row-btn" class="w-full text-sm bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-4 rounded-lg transition">+ Tambah Baris</button>
                        </div>
                        <!-- Excel Import -->
                        <div>
                            <h2 class="text-lg font-semibold text-slate-700 mb-4">Impor dari File</h2>
                            <p class="text-sm text-slate-500 mb-4">Unggah file .xlsx dengan satu kolom berisi nama siswa.</p>
                            <button id="download-template-btn" class="w-full mb-3 text-sm bg-green-100 hover:bg-green-200 text-green-700 font-semibold py-2 px-4 rounded-lg transition">Unduh Template (.csv)</button>
                            <input type="file" id="excel-upload" class="hidden" accept=".xlsx, .xls, .csv"/>
                            <button id="import-excel-btn" class="w-full text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-2 px-4 rounded-lg transition">Pilih File Excel untuk Diimpor</button>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t border-slate-200 flex justify-end gap-4">
                        <button id="cancel-add-students-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-6 rounded-lg transition">Batal</button>
                        <button id="save-students-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition">Simpan & Mulai Absensi</button>
                    </div>
                </div>
            </div>`,
        attendance: (className, date) => `
            <div class="screen active p-4 md:p-8 max-w-4xl mx-auto">
                 <div class="bg-white p-8 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">Absensi Kelas ${className}</h1>
                            <p class="text-slate-500">Tanggal: ${new Date(date + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        </div>
                         <button id="back-to-setup-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition text-sm">Kembali</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b bg-slate-50">
                                    <th class="p-3 text-sm font-semibold text-slate-600">No.</th>
                                    <th class="p-3 text-sm font-semibold text-slate-600">Nama Siswa</th>
                                    <th class="p-3 text-sm font-semibold text-slate-600 text-center">Hadir (H)</th>
                                    <th class="p-3 text-sm font-semibold text-slate-600 text-center">Sakit (S)</th>
                                    <th class="p-3 text-sm font-semibold text-slate-600 text-center">Izin (I)</th>
                                    <th class="p-3 text-sm font-semibold text-slate-600 text-center">Alfa (A)</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button id="save-attendance-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition">Simpan Absensi</button>
                    </div>
                </div>
            </div>`,
        success: () => `
            <div class="screen active min-h-screen flex flex-col items-center justify-center p-4 text-center">
                <div class="bg-white p-8 md:p-12 rounded-2xl shadow-lg max-w-md w-full animate-fade-in">
                    <div class="checkmark-wrapper mx-auto mb-6">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-3">Absensi Tersimpan!</h1>
                    <p class="text-slate-500 mb-10">Terima kasih, data absensi telah berhasil disimpan ke Google Sheet.</p>
                    <div class="space-y-4">
                         <button id="success-back-to-start-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-full transition duration-300 text-lg">Kembali ke Halaman Awal</button>
                         <button id="success-view-data-btn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg w-full transition duration-300">Lihat Semua Riwayat</button>
                    </div>
                </div>
            </div>`,
        data: () => `
             <div class="screen active p-4 md:p-8 max-w-5xl mx-auto">
                 <div class="bg-white p-8 rounded-2xl shadow-lg">
                     <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                        <h1 id="data-title" class="text-2xl font-bold text-slate-800">Riwayat Data Absensi</h1>
                        <button id="data-back-to-start-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition text-sm">Kembali</button>
                    </div>
                    <div id="data-container" class="space-y-6"></div>
                 </div>
            </div>`,
        confirmation: (message) => `
            <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                 <div class="bg-white p-8 rounded-2xl shadow-lg max-w-sm w-full text-center animate-fade-in">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Konfirmasi</h2>
                    <p class="text-slate-600 mb-8">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-no-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-8 rounded-lg transition">Tidak</button>
                        <button id="confirm-yes-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition">Ya</button>
                    </div>
                </div>
            </div>`,
        privacy: () => `
            <div class="screen active p-4 md:p-8 max-w-3xl mx-auto">
                <div class="bg-white p-8 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                        <h1 class="text-2xl font-bold text-slate-800">Kebijakan Privasi</h1>
                        <a href="#" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition text-sm">Kembali</a>
                    </div>
                    <div class="text-slate-600 leading-relaxed">${privacyPolicyContent}</div>
                </div>
            </div>`,
        terms: () => `
            <div class="screen active p-4 md:p-8 max-w-3xl mx-auto">
                <div class="bg-white p-8 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                        <h1 class="text-2xl font-bold text-slate-800">Ketentuan Layanan</h1>
                        <a href="#" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition text-sm">Kembali</a>
                    </div>
                    <div class="text-slate-600 leading-relaxed">${termsOfServiceContent}</div>
                </div>
            </div>`,
    };

    const privacyPolicyContent = `
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Pengumpulan dan Penggunaan Informasi</h3>
        <p class="mb-4">Aplikasi ini berinteraksi dengan Google APIs untuk menyediakan fungsionalitas utamanya. Saat Anda login dengan akun Google, kami meminta izin untuk mengakses informasi dasar profil Anda (nama, email, foto profil) untuk personalisasi aplikasi. Kami juga meminta izin untuk mengelola file Google Sheets dan Google Drive yang dibuat secara khusus oleh aplikasi ini.</p>
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Penyimpanan Data</h3>
        <p class="mb-4">Semua data absensi yang Anda masukkan disimpan langsung di dalam file Google Sheet di akun Google Drive Anda. Aplikasi ini tidak menyimpan data Anda di server kami sendiri. Keamanan data Anda bergantung pada keamanan akun Google Anda.</p>
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Penggunaan Data</h3>
        <ul class="list-disc list-inside mb-4 space-y-1">
            <li>Data profil Anda digunakan untuk menampilkan identitas Anda di dalam aplikasi.</li>
            <li>Izin Google Sheets digunakan untuk membuat, membaca, dan menulis data absensi ke spreadsheet Anda.</li>
            <li>Izin Google Drive digunakan untuk menemukan spreadsheet absensi yang relevan yang dibuat oleh aplikasi ini.</li>
        </ul>
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Berbagi Data</h3>
        <p class="mb-4">Kami tidak membagikan informasi pribadi atau data absensi Anda kepada pihak ketiga manapun. Data tersebut hanya dapat diakses oleh Anda melalui akun Google Anda.</p>
    `;

    const termsOfServiceContent = `
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Penerimaan Ketentuan</h3>
        <p class="mb-4">Dengan menggunakan aplikasi Absensi Online Siswa ("Layanan"), Anda setuju untuk terikat oleh Ketentuan Layanan ini. Jika Anda tidak setuju dengan ketentuan ini, mohon untuk tidak menggunakan layanan ini.</p>
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Deskripsi Layanan</h3>
        <p class="mb-4">Layanan ini adalah alat bantu untuk mencatat absensi siswa yang terintegrasi dengan akun Google Anda. Layanan ini memungkinkan Anda membuat dan mengelola data absensi dalam Google Sheet pribadi Anda.</p>
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Tanggung Jawab Pengguna</h3>
        <ul class="list-disc list-inside mb-4 space-y-1">
            <li>Anda bertanggung jawab penuh atas keamanan akun Google Anda.</li>
            <li>Anda bertanggung jawab atas keakuratan data yang Anda masukkan ke dalam aplikasi.</li>
            <li>Anda setuju untuk tidak menggunakan layanan ini untuk tujuan yang melanggar hukum.</li>
        </ul>
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Batasan Tanggung Jawab</h3>
        <p class="mb-4">Layanan ini disediakan "sebagaimana adanya". Pengembang tidak bertanggung jawab atas kehilangan data atau kerusakan apa pun yang timbul dari penggunaan aplikasi ini. Cadangkan data penting Anda secara teratur.</p>
    `;

    // --- RENDER FUNCTION ---
    function render() {
        // Clear previous content
        appContainer.innerHTML = '';
        
        switch(state.currentScreen) {
            case 'login':
                appContainer.innerHTML = templates.login();
                document.getElementById('loginBtn').addEventListener('click', handleAuthClick);
                break;
            case 'setup':
                appContainer.innerHTML = templates.setup(state.userProfile);
                document.getElementById('logoutBtn').addEventListener('click', handleSignoutClick);
                document.getElementById('startBtn').addEventListener('click', handleStartAttendance);
                document.getElementById('historyBtn').addEventListener('click', () => handleViewHistory(true)); // View class-specific history
                document.getElementById('class-select').value = state.selectedClass || CLASSES[0];
                if (state.spreadsheetId) {
                    const startBtn = document.getElementById('startBtn');
                    if (startBtn) startBtn.disabled = false;
                    const statusEl = document.getElementById('setup-status');
                    if (statusEl) statusEl.textContent = 'Spreadsheet siap digunakan.';
                }
                break;
            case 'add-students':
                appContainer.innerHTML = templates.addStudents(state.selectedClass);
                renderStudentInputRows();
                document.getElementById('add-student-row-btn').addEventListener('click', addStudentInputRow);
                document.getElementById('download-template-btn').addEventListener('click', handleDownloadTemplate);
                document.getElementById('import-excel-btn').addEventListener('click', () => document.getElementById('excel-upload').click());
                document.getElementById('excel-upload').addEventListener('change', handleExcelImport);
                document.getElementById('cancel-add-students-btn').addEventListener('click', () => navigateTo('setup'));
                document.getElementById('save-students-btn').addEventListener('click', handleSaveNewStudents);
                break;
            case 'attendance':
                appContainer.innerHTML = templates.attendance(state.selectedClass, state.selectedDate);
                renderAttendanceTable();
                document.getElementById('back-to-setup-btn').addEventListener('click', () => navigateTo('setup'));
                document.getElementById('save-attendance-btn').addEventListener('click', handleSaveAttendance);
                break;
            case 'success':
                 appContainer.innerHTML = templates.success();
                 document.getElementById('success-back-to-start-btn').addEventListener('click', () => navigateTo('setup'));
                 document.getElementById('success-view-data-btn').addEventListener('click', () => handleViewHistory(false)); // View all history
                 break;
            case 'data':
                appContainer.innerHTML = templates.data();
                renderDataScreen();
                document.getElementById('data-back-to-start-btn').addEventListener('click', () => navigateTo('setup'));
                break;
            case 'privacy':
                appContainer.innerHTML = templates.privacy();
                break;
            case 'terms':
                appContainer.innerHTML = templates.terms();
                break;
        }

        // Show app and hide loader if not already done
        if (!appContainer.classList.contains('active')) {
             appContainer.classList.remove('hidden');
             loaderWrapper.style.opacity = '0';
             setTimeout(() => {
                loaderWrapper.style.display = 'none';
                loaderWrapper.querySelector('.loader-text').textContent = 'Memuat Aplikasi Absensi...'; // Reset text
             }, 300);
        }
    }
    
    function navigateTo(screen) {
        state.currentScreen = screen;
        render();
    }
    
    // --- UI HELPERS ---
    function showLoader(message) {
        loaderWrapper.querySelector('.loader-text').textContent = message;
        loaderWrapper.style.display = 'flex';
        setTimeout(() => loaderWrapper.style.opacity = '1', 10);
    }

    function hideLoader() {
        loaderWrapper.style.opacity = '0';
        setTimeout(() => loaderWrapper.style.display = 'none', 300);
    }
    
    function showConfirmation(message) {
        return new Promise(resolve => {
            const existingModal = document.getElementById('confirmation-modal');
            if (existingModal) existingModal.parentElement.remove();
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = templates.confirmation(message);
            document.body.appendChild(modalContainer);

            const cleanup = () => {
                if(document.body.contains(modalContainer)){
                    document.body.removeChild(modalContainer);
                }
            }

            document.getElementById('confirm-yes-btn').onclick = () => {
                cleanup();
                resolve(true);
            };
            document.getElementById('confirm-no-btn').onclick = () => {
                cleanup();
                resolve(false);
            };
        });
    }

    // --- SCREEN SPECIFIC RENDER LOGIC ---
    function renderStudentInputRows() {
        const container = document.getElementById('manual-input-container');
        container.innerHTML = '';
        state.newStudents.forEach((name, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="text" value="${name}" data-index="${index}" class="student-name-input w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nama Siswa ${index + 1}">
                <button data-index="${index}" class="remove-student-row-btn text-slate-400 hover:text-red-500 p-1 text-2xl font-bold leading-none">&times;</button>
            `;
            container.appendChild(div);
        });
        document.querySelectorAll('.student-name-input').forEach(input => {
            input.addEventListener('input', (e) => {
                state.newStudents[e.target.dataset.index] = e.target.value;
            });
        });
        document.querySelectorAll('.remove-student-row-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                removeStudentInputRow(e.target.dataset.index);
            });
        });
    }

    function addStudentInputRow() {
        state.newStudents.push('');
        renderStudentInputRows();
        const inputs = document.querySelectorAll('.student-name-input');
        inputs[inputs.length - 1].focus();
    }
    
    function removeStudentInputRow(index) {
        state.newStudents.splice(index, 1);
        if (state.newStudents.length === 0) {
            state.newStudents.push('');
        }
        renderStudentInputRows();
    }
    
    function renderAttendanceTable() {
        const tbody = document.getElementById('attendance-table-body');
        tbody.innerHTML = '';
        state.students.forEach((student, index) => {
            const tr = document.createElement('tr');
            tr.className = 'border-b hover:bg-slate-50 transition';
            const status = state.attendance[student] || 'H'; // Default to Hadir
            tr.innerHTML = `
                <td class="p-3 text-sm text-slate-500">${index + 1}</td>
                <td class="p-3 font-medium text-slate-800">${student}</td>
                ${['H', 'S', 'I', 'A'].map(s => `
                    <td class="p-3 text-center">
                        <input type="radio" name="status-${index}" value="${s}" class="w-5 h-5 accent-blue-500" ${status === s ? 'checked' : ''} data-student="${student}">
                    </td>
                `).join('')}
            `;
            tbody.appendChild(tr);
        });

        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.attendance[e.target.dataset.student] = e.target.value;
            });
        });
    }

    function renderDataScreen() {
        const container = document.getElementById('data-container');
        const titleEl = document.getElementById('data-title');
        
        const logsToShow = state.historyClassFilter 
            ? state.savedLogs.filter(log => log.class === state.historyClassFilter)
            : state.savedLogs;
            
        if (state.historyClassFilter) {
            titleEl.textContent = `Riwayat Absensi Kelas ${state.historyClassFilter}`;
        }

        if (logsToShow.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500">Belum ada riwayat absensi yang tersimpan.</p>`;
            return;
        }

        const groupedByDate = logsToShow.reduce((acc, log) => {
            const dateStr = log.date; // Use the reliable YYYY-MM-DD string for grouping
            if (!acc[dateStr]) acc[dateStr] = [];
            acc[dateStr].push(log);
            return acc;
        }, {});

        container.innerHTML = Object.entries(groupedByDate)
            .sort((a, b) => new Date(b[0]) - new Date(a[0])) // Sort by the YYYY-MM-DD key
            .map(([date, logs]) => {
                // Format the date for display inside the map
                const displayDate = new Date(date + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const logsHtml = logs.map(log => {
                    const absentStudents = Object.entries(log.attendance)
                        .filter(([_, status]) => status !== 'H');
                    
                    let contentHtml;
                    if (absentStudents.length > 0) {
                        const attendanceToShow = Object.fromEntries(absentStudents);
                        contentHtml = `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="text-left text-slate-500">
                                        <th class="py-1 pr-4 font-medium">Nama Siswa</th>
                                        <th class="py-1 px-2 font-medium">Status</th>
                                    </tr></thead>
                                    <tbody>
                                    ${Object.entries(attendanceToShow).map(([name, status]) => `
                                        <tr class="border-t border-slate-200">
                                            <td class="py-2 pr-4 text-slate-700">${name}</td>
                                            <td class="py-2 px-2"><span class="px-2 py-1 rounded-full text-xs font-semibold 
                                                ${status === 'S' ? 'bg-yellow-100 text-yellow-800' :
                                                  status === 'I' ? 'bg-blue-100 text-blue-800' :
                                                  'bg-red-100 text-red-800'}">${status}</span></td>
                                        </tr>
                                    `).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                    } else {
                        contentHtml = `<p class="text-sm text-slate-500 italic px-1 py-2">Semua siswa hadir.</p>`;
                    }

                    return `
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h3 class="font-bold text-blue-600 mb-2">Kelas ${log.class}</h3>
                            ${contentHtml}
                        </div>`;
                }).join('');

                return `
                <div>
                    <h2 class="text-lg font-semibold text-slate-700 mb-3">${displayDate}</h2>
                    <div class="space-y-4">
                        ${logsHtml}
                    </div>
                </div>`;
            }).join('');
    }

    // --- GOOGLE API & AUTH LOGIC ---
    
    function displayAuthError(message, error = null) {
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const errorContainer = document.getElementById('auth-error-container');
        const errorMessageEl = document.getElementById('auth-error-message');
        const originHelper = document.getElementById('origin-helper');
        const errorOriginEl = document.getElementById('auth-error-origin');
        const copyOriginBtn = document.getElementById('copy-origin-btn');
        const techDetailsEl = document.getElementById('auth-error-tech-details');
        
        if (loginBtn) {
            loginBtn.disabled = true;
            loginBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            loginBtn.classList.add('bg-red-500');
        }
        if (loginBtnText) {
            loginBtnText.textContent = 'Gagal Memuat';
        }

        if (errorContainer) errorContainer.classList.remove('hidden');
        if (errorMessageEl) errorMessageEl.textContent = message;

        const isInitError = error && error.message && (error.message.toLowerCase().includes('gapi') || error.message.toLowerCase().includes('gis') || error.message.toLowerCase().includes('discovery'));
        
        if (originHelper && isInitError) {
            originHelper.classList.remove('hidden');
            const origin = window.location.origin;
            if (errorOriginEl) errorOriginEl.textContent = origin;
            if (copyOriginBtn) {
                copyOriginBtn.onclick = () => {
                    navigator.clipboard.writeText(origin).then(() => {
                        document.getElementById('copy-icon').classList.add('hidden');
                        const checkIcon = document.getElementById('check-icon');
                        checkIcon.classList.remove('hidden');
                        setTimeout(() => {
                            checkIcon.classList.add('hidden');
                            document.getElementById('copy-icon').classList.remove('hidden');
                        }, 2000);
                    });
                };
            }
        }
        
        if (techDetailsEl && error) {
            techDetailsEl.textContent = `Detail Teknis: ${error.message || String(error)}`;
        }
        console.error("Auth Error:", message, error);
    }

    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            script.defer = true;
            script.onload = resolve;
            script.onerror = () => reject(new Error(`Gagal memuat skrip: ${src}`));
            document.head.appendChild(script);
        });
    }

    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    async function retry(fn, retries = 3, delay = 1000, finalErrorMessage = 'Gagal setelah beberapa kali percobaan') {
        let lastError;
        for (let i = 0; i < retries; i++) {
            try {
                return await fn();
            } catch (error) {
                lastError = error;
                console.warn(`Percobaan inisialisasi API #${i + 1} gagal. Mencoba lagi dalam ${delay}ms...`, error);
                await wait(delay);
                delay *= 2; // Exponential backoff
            }
        }
        throw new Error(`${finalErrorMessage}. Error terakhir: ${lastError.message || String(lastError)}`);
    }

    async function initializeApis() {
        const initGapiClient = async () => {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [
                    'https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest',
                    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                ],
            });
        };

        const gapiPromise = (async () => {
            try {
                await loadScript('https://apis.google.com/js/api.js');
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: (err) => reject(new Error('Gagal memuat modul GAPI client.')),
                        timeout: 10000,
                        ontimeout: () => reject(new Error('Waktu tunggu habis saat memuat GAPI.'))
                    });
                });
                await retry(initGapiClient, 3, 1000, 'Gagal memuat konfigurasi API dari Google');
            } catch (err) {
                console.error("GAPI Initialization Failed:", err);
                let detailMessage = err.message || 'Tidak diketahui.';
                if (err.message && err.message.includes('missing required fields')) {
                    detailMessage = 'Gagal memuat file konfigurasi API dari Google.';
                }
                const userSuggestion = 'Ini seringkali disebabkan oleh masalah jaringan, ad-blocker, atau firewall. Periksa koneksi Anda, nonaktifkan ad-blocker untuk situs ini, dan muat ulang halaman.';
                throw new Error(`Gagal menginisialisasi Google API (GAPI). ${userSuggestion} Detail teknis: ${detailMessage}`);
            }
        })();

        const gisPromise = (async () => {
            try {
                await loadScript('https://accounts.google.com/gsi/client');
                state.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // Handled manually
                });
            } catch (err) {
                console.error("GIS Initialization Failed:", err);
                const detailMessage = err.message || JSON.stringify(err);
                const userSuggestion = 'Periksa koneksi internet Anda dan pastikan tidak ada yang memblokir skrip Google.';
                throw new Error(`Gagal menginisialisasi Google Sign-In (GIS). ${userSuggestion} Detail: ${detailMessage}`);
            }
        })();

        return Promise.all([gapiPromise, gisPromise]);
    }

    function handleAuthClick() {
        state.tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                console.error("Authentication error:", resp);
                const authError = new Error(resp.error_description || resp.error);
                displayAuthError(`Otentikasi Gagal: ${resp.error}`, authError);
                throw (resp);
            }
            const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }
            });
            state.userProfile = await response.json();
            
            navigateTo('setup');
            setTimeout(() => {
                findOrCreateSpreadsheet();
            }, 0);
        };
        
        if (gapi.client.getToken() === null) {
            state.tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
            state.tokenClient.requestAccessToken({ prompt: '' });
        }
    }
    
    function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token, () => {
                gapi.client.setToken('');
                state.userProfile = null;
                state.spreadsheetId = null;
                navigateTo('login');
            });
        }
    }

    async function findOrCreateSpreadsheet() {
        updateSetupStatus('Mencari spreadsheet...');
        const response = await gapi.client.drive.files.list({
            q: `mimeType='application/vnd.google-apps.spreadsheet' and name='${SPREADSHEET_TITLE}' and trashed=false`,
            fields: 'files(id, name)',
        });
        
        if (response.result.files && response.result.files.length > 0) {
            state.spreadsheetId = response.result.files[0].id;
            updateSetupStatus('Spreadsheet ditemukan.', true);
            await loadAllDataFromSheet();
        } else {
            updateSetupStatus('Spreadsheet tidak ditemukan, membuat baru...');
            const createResponse = await gapi.client.sheets.spreadsheets.create({
                properties: { title: SPREADSHEET_TITLE },
                sheets: [{ properties: { title: 'Siswa' } }, { properties: { title: 'Absensi' } }]
            });
            state.spreadsheetId = createResponse.result.spreadsheetId;

            const headerRequests = [
                { range: 'Siswa!A1:B1', values: [['Kelas', 'Nama Siswa']]},
                { range: 'Absensi!A1:D1', values: [['Tanggal', 'Kelas', 'Nama Siswa', 'Status']] }
            ];
            await gapi.client.sheets.spreadsheets.values.batchUpdate({
                spreadsheetId: state.spreadsheetId,
                resource: {
                    valueInputOption: 'USER_ENTERED',
                    data: headerRequests
                }
            });
            updateSetupStatus('Spreadsheet baru berhasil dibuat.', true);
        }
    }

    async function loadAllDataFromSheet() {
        updateSetupStatus('Memuat data dari Google Sheet...');
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: state.spreadsheetId,
            range: 'Absensi!A2:D'
        });
        if (response.result.values) {
            state.savedLogs = response.result.values.map(([date, className, studentName, status]) => ({
                date, class: className, attendance: { [studentName]: status }
            })).reduce((acc, log) => {
                const existing = acc.find(item => item.date === log.date && item.class === log.class);
                if (existing) {
                    Object.assign(existing.attendance, log.attendance);
                } else {
                    acc.push(log);
                }
                return acc;
            }, []);
        } else {
            state.savedLogs = [];
        }
        updateSetupStatus('Data berhasil dimuat.', true);
    }
    
    function updateSetupStatus(message, success = false) {
        const statusEl = document.getElementById('setup-status');
        const startBtn = document.getElementById('startBtn');
        if (statusEl) statusEl.textContent = message;
        if (startBtn) startBtn.disabled = !success;
    }

    // --- EVENT HANDLERS & LOGIC ---
    
    async function handleStartAttendance() {
        state.selectedClass = document.getElementById('class-select').value;
        state.selectedDate = document.getElementById('date-input').value;

        // Check for existing data for the same class and date
        const existingLog = state.savedLogs.find(log => log.class === state.selectedClass && log.date === state.selectedDate);

        if (existingLog) {
            const message = `Absensi untuk kelas ${state.selectedClass} pada tanggal ${state.selectedDate} sudah ada. Apakah Anda ingin mengisinya kembali? Data lama akan ditimpa saat menyimpan.`;
            const confirmed = await showConfirmation(message);
            if (!confirmed) {
                return; // User cancelled
            }
        }

        // Fetch students for the selected class from 'Siswa' sheet
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: state.spreadsheetId,
            range: 'Siswa!A2:B'
        });
        
        state.students = (response.result.values || [])
            .filter(row => row[0] === state.selectedClass)
            .map(row => row[1]);

        if (state.students.length === 0) {
            state.newStudents = ['']; // Reset for new class
            navigateTo('add-students');
        } else {
            // Reset attendance for new session
            state.attendance = {};
            state.students.forEach(s => state.attendance[s] = 'H');
            navigateTo('attendance');
        }
    }

    async function handleSaveNewStudents() {
        const newStudentNames = state.newStudents.map(s => s.trim()).filter(s => s);
        if (newStudentNames.length === 0) {
            alert('Harap tambahkan setidaknya satu nama siswa.');
            return;
        }

        const rows = newStudentNames.map(name => [state.selectedClass, name]);

        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: state.spreadsheetId,
            range: 'Siswa!A:B',
            valueInputOption: 'USER_ENTERED',
            resource: {
                values: rows
            }
        });

        state.students = newStudentNames;
        state.attendance = {};
        state.students.forEach(s => state.attendance[s] = 'H');
        navigateTo('attendance');
    }

    async function handleSaveAttendance() {
        const message = `Anda akan menyimpan data absensi untuk kelas ${state.selectedClass} pada tanggal ${state.selectedDate}. Pastikan data sudah benar. Lanjutkan?`;
        const confirmed = await showConfirmation(message);
        if (!confirmed) return;

        showLoader('Menyimpan data...');

        try {
            // 1. Get all existing attendance data
            const allAttendanceResponse = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: state.spreadsheetId,
                range: 'Absensi!A2:D'
            });
            const allAttendanceData = allAttendanceResponse.result.values || [];

            // 2. Filter out data for the current class and date to be replaced
            const otherAttendanceData = allAttendanceData.filter(row => {
                const [date, className] = row;
                return !(date === state.selectedDate && className === state.selectedClass);
            });

            // 3. Prepare new data to be added
            const newRows = Object.entries(state.attendance).map(([studentName, status]) => [
                state.selectedDate,
                state.selectedClass,
                studentName,
                status
            ]);
            
            // 4. Combine old (filtered) and new data
            const finalData = [...otherAttendanceData, ...newRows];

            // 5. Clear the entire data range in the sheet
            await gapi.client.sheets.spreadsheets.values.clear({
                spreadsheetId: state.spreadsheetId,
                range: 'Absensi!A2:D',
            });

            // 6. Write back the combined data if there is any
            if (finalData.length > 0) {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: state.spreadsheetId,
                    range: 'Absensi!A2',
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: finalData
                    }
                });
            }

            await loadAllDataFromSheet(); // Reload data
            navigateTo('success');

        } catch (error) {
            console.error('Failed to save attendance:', error);
            alert(`Gagal menyimpan data absensi. Silakan coba lagi. Error: ${error.result?.error?.message || error.message}`);
        } finally {
            hideLoader();
        }
    }
    
    function handleViewHistory(isClassSpecific = false) {
        if (isClassSpecific) {
            const selectedClass = document.getElementById('class-select').value;
            const classHistory = state.savedLogs.filter(log => log.class === selectedClass);

            if (classHistory.length === 0) {
                alert(`Data riwayat absensi untuk kelas ${selectedClass} tidak ditemukan.`);
                return;
            }
            state.historyClassFilter = selectedClass;
        } else {
            state.historyClassFilter = null; // Show all
        }
        navigateTo('data');
    }

    function handleDownloadTemplate() {
        const csvContent = "data:text/csv;charset=utf-8," + "Nama Siswa\nContoh Siswa 1\nContoh Siswa 2";
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "template_siswa.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function handleExcelImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            const studentNames = json
                .slice(1) // Skip header row
                .map(row => row[0]) // Get first column
                .filter(name => typeof name === 'string' && name.trim() !== '');

            if (studentNames.length > 0) {
                state.newStudents = studentNames;
                renderStudentInputRows();
                alert(`${studentNames.length} siswa berhasil diimpor dari file.`);
            } else {
                alert('Tidak ada nama siswa yang ditemukan di file. Pastikan nama ada di kolom pertama.');
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // --- ROUTING ---
    function handleHashChange() {
        const hash = window.location.hash.substring(1);

        const routes = {
            'privacy': 'privacy',
            'terms': 'terms',
        };

        const targetScreen = routes[hash];
        
        // If we have a valid hash route, navigate if not already there.
        if (targetScreen) {
            if (state.currentScreen !== targetScreen) {
                navigateTo(targetScreen);
            }
            return;
        }

        // If hash is empty or invalid...
        if (!state.userProfile) {
            // ...and user is not logged in, go to login screen if not already there.
            if (state.currentScreen !== 'login') {
                navigateTo('login');
            }
        } else {
            // ...and user is logged in, go to main setup screen if they are on a non-primary screen.
            if (!['setup', 'attendance', 'add-students', 'data', 'success'].includes(state.currentScreen)) {
                navigateTo('setup');
            }
        }
    }

    // --- INITIALIZATION ---
    async function main() {
        render(); 
        try {
            await initializeApis();
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            if (loginBtn && loginBtnText) {
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Login dengan Google';
            }
        } catch (error) {
            displayAuthError('Gagal melakukan inisialisasi.', error);
        }
        
        window.addEventListener('hashchange', handleHashChange);
        handleHashChange(); // Handle initial page load with hash
    }
    
    main();

</script>

</body>
</html>
